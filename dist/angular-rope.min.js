/**
 * Angular Promise Chaining Service
 * @version v0.3.0 - 2013-12-31
 * @link https://github.com/platanus/angular-rope
 * @author Ignacio Baixas <ignacio@platan.us>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a){"use strict";var b={};a.module("platanus.rope",[]).factory("rope",["$q","$timeout",function(c,d){function e(a){return a&&"function"==typeof a.then?a:{then:function(b){if(!b)return this;try{return e(b(a))}catch(c){return f(c)}},"finally":function(a){try{var b=a();return"undefined"==typeof b?this:b}catch(c){return f(c)}}}}function f(a){return{then:function(b,c){if(!c)return this;try{return e(c(a))}catch(d){return f(d)}},"finally":function(a){try{return a(),this}catch(b){return f(b)}}}}function g(a,b,d,e,f){for(var g,h,i,j=d;"function"==typeof j;)try{g=m,m={parent:a,chains:[],context:b,data:e,error:f},j=j.call(b,e)}finally{if(h=m.chains.length,1===h)j=m.chains[0].promise;else if(h>1){for(j=[],i=0;h>i;i++)j.push(m.chains[i].promise);j=c.all(j)}m=g}return"undefined"!=typeof j||f?j:e}function h(a){return a.$$exit||a.$$ctxBlk&&a.$$ctxBlk.length>0&&!a.$$ctxBlk[a.$$ctxBlk.length-1]}function i(a){return a||(m?m.context:null)}function j(a){this.value=a}function k(a){return a&&a instanceof j?a.value:a}function l(a){this.promise=a,m&&m.chains.push(this)}var m=null;l.prototype={loadParentStatus:function(){var a=m;return this.next(function(){return a.error?f(a.data):e(a.data)})},loadParentStack:function(){var a=this,b=m;return this.next(function(c){return a.stack=b.parent.stack,c})},loadParent:function(){return this.loadParentStack().loadParentStatus()},seed:function(a,b){return this.next(new j(a),b)},next:function(a,b){var c=this,d=i(b);return this.promise=this.promise.then(function(b){return h(c)?b:g(c,d,a,k(b),!1)}),this},handle:function(a,b){var c=this,d=i(b);return this.promise=this.promise.then(null,function(b){return h(c)?f(b):g(c,d,a,b,!0)}),this},always:function(a,b){return this.next(function(){return"function"==typeof a?a.apply(this):a},b).handle(function(b){return e("function"==typeof a?a.apply(this):a).then(function(){return f(b)},function(){return f(b)})},b),this},nextIf:function(a,c){var d=this;return this.promise=this.promise.then(function(f){if(h(d))d.$$ctxBlk.push(!1);else{if(d.$$ctxBlk||(d.$$ctxBlk=[]),"undefined"!=typeof a)return e(g(d,c,a,k(f),!1)).then(function(a){return d.$$ctxBlk.push(a===b?null:!!a),f});d.$$ctxBlk.push(!!f)}return f}).then(null,function(a){return d.$$ctxBlk.push(!1),f(a)}),this},orNextIf:function(a,c){var d,e=this;return this.promise=this.promise["finally"](function(){d=e.$$ctxBlk.pop()}),this.nextIf(function(){return d===!1?a:b},c)},nextUnless:function(a,b){var c=this;return this.nextIf(function(b){return e(g(c,this,a,b,!1)).then(function(a){return!a})},b)},orNextUnless:function(a,b){var c=this;return this.orNextIf(function(b){return e(g(c,this,a,b,!1)).then(function(a){return!a})},b)},orNext:function(){return this.orNextIf(!0)},nextCase:function(a){return this.nextIf(function(b){return a==b})},orNextCase:function(a){return this.orNextIf(function(b){return a==b})},end:function(){var a=this;return this.promise=this.promise["finally"](function(){a.$$ctxBlk.pop()}),this},exit:function(){var a=this;return this.next(function(){a.$$exit=!0})},wait:function(a){return this.promise=this.promise.then(function(b){var e=c.defer();return d(function(){e.resolve(b)},a),e.promise}),this},apply:function(a,b){return this.next(function(c){return c[a].apply(c,b)})},call:function(a){var b=Array.prototype.slice.call(arguments,1);return this.apply(a,b)},forkEach:function(b,c){return this.next(function(d){a.forEach(d,function(a){new l(e(a)).next(b,c)})})},get:function(a){return this.next(function(){return this[a]})},set:function(a){return this.next(function(b){return this[a]=b,b})},push:function(){var a=this,b=arguments;return this.next(function(c){return a.stack||(a.stack=[]),b.length>0?Array.prototype.push.apply(a.stack,b):a.stack.push(c),c})},pop:function(a){var b=this;return this.next(function(c){return b.stack||(b.stack=[]),a?(this[a]=b.stack.pop(),c):b.stack.pop()})}};var n={confer:e,reject:f,task:function(a){return function(){var b=arguments,c=this;return function(d){n.seed(d).next(function(){return a.apply(this,b)},c)}}}};return a.forEach(["loadParentStatus","loadParentStack","loadParent","seed","next","nextIf","nextUnless","get","set","push"],function(a){var b=l.prototype[a];n[a]=function(){return b.apply(new l(e(null)),arguments)}}),n}])}(angular);