/**
 * Angular Promise Chaining Service
 * @version v0.1.0 - 2013-12-22
 * @link https://github.com/platanus/angular-rope
 * @author Ignacio Baixas <ignacio@platan.us>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a){"use strict";a.module("platanus.rope",[]).factory("rope",["$q",function(b){function c(a){return a&&"function"==typeof a.then?a:a&&a.$promise?a.$promise:{then:function(b){if(!b)return this;try{var e=b(a);return"undefined"!=typeof e?c(e):this}catch(f){return d(f)}},"finally":function(a){try{var b=a();return"undefined"!=typeof b?c(b):this}catch(e){return d(e)}}}}function d(a){return{then:function(b,e){if(!e)return this;try{var f=e(a);return"undefined"!=typeof f?c(f):this}catch(g){return d(g)}},"finally":function(a){try{var b=a();return"undefined"!=typeof b?d(b):this}catch(c){return d(c)}}}}function e(a,c,d){var e,f,g,h,k;if("function"==typeof c){try{e=i,f=j,i=[],j=a,g=c.call(j,d)}finally{if(h=i.length,1==h)g=i[0].promise;else if(h>1){for(g=[],k=0;h>k;k++)g.push(i[k].promise);g=b.all(g)}i=e,j=f}return g}return c}function f(a){this.value=a}function g(a){return a&&a instanceof f?a.value:a}function h(a){this.promise=a,i&&i.push(this)}var i=null,j=null;return h.prototype={$$skip:function(){return this.$$cstack&&this.$$cstack.length>0&&!this.$$cstack[this.$$cstack.length-1]},seed:function(a,b){return this.next(new f(a),b)},next:function(a,b){var c=this,d=b||j;return this.promise=this.promise.then(function(b){return c.$$skip()?void 0:e(d,a,g(b))}),this},handle:function(a,b){var d=this,f=b||j;return this.promise=this.promise.then(null,function(b){return d.$$skip()?void 0:c(e(f,a,b))}),this},always:function(a,b){var d=this,f=b||j;return this.promise=this.promise["finally"](function(){return d.$$skip()?void 0:c(e(f,a))}),this},nextIf:function(a,b){var f=this;return this.promise=this.promise.then(function(d){return f.$$cstack||(f.$$cstack=[]),"undefined"!=typeof a?c(e(b,a,g(d))).then(function(a){return f.$$cstack.push(!!a),d}):(f.$$cstack.push(d),void 0)}).then(null,function(a){return f.$$cstack.push(!1),d(a)}),this},orNextIf:function(a,b){var f=this;return this.promise=this.promise.then(function(d){var h=f.$$cstack[f.$$cstack.length-1];return h===!1?c(e(b,a,g(d))).then(function(a){return f.$$cstack.pop(),f.$$cstack.push(!!a),d}):(h&&(f.$$cstack.pop(),f.$$cstack.push(null)),void 0)}).then(null,function(a){return f.$$cstack.pop(),f.$$cstack.push(!1),d(a)}),this},orNext:function(){return this.orNextIf(!0)},nextCase:function(a){return this.nextIf(function(b){return a===b})},orNextCase:function(a){return this.orNextIf(function(b){return a===b})},end:function(){var a=this;return this.promise=this.promise["finally"](function(){a.$$cstack.pop()}),this},forkEach:function(b,d){this.next(function(e){a.forEach(e,function(a){new h(c(a)).next(b,d)})})}},{confer:c,reject:d,task:function(a){return function(){var b=arguments,c=this;return function(d){var e=c.$value;c.$value=g(d);try{return a.apply(c,b)}finally{c.$value=e}}}},seed:function(a){return new h(c(new f(a)))},next:function(a,b){return new h(c(null)).next(a,b)},nextIf:function(a,b){return new h(c(null)).nextIf(a,b)}}}])}(angular);